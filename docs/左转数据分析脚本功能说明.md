# 左转数据分析脚本功能详解

## 概述

左转数据分析脚本（`src/左转数据分析脚本.py`）是一个专业的**车辆左转行为分析工具**，专门用于城市交叉路口的交通数据分析。该脚本是车辆左转轨迹预测系统的重要组成部分，为深度学习模型提供高质量的训练数据和分析基础。

## 🎯 核心功能

### 1. **数据加载与预处理**
- **NGSIM数据加载**：支持加载NGSIM交通数据（peachtree路口数据）
- **格式自动识别**：自动识别数据格式和列名结构
- **数据质量检查**：检查数据完整性和有效性
- **统计信息输出**：显示数据规模、车辆数量等基本信息

```python
def load_data(self):
    """加载数据"""
    # 加载CSV文件
    # 输出数据统计信息
    # 返回加载状态
```

### 2. **左转车辆智能识别**
- **航向角分析**：基于车辆位置变化计算实时航向角
- **左转判断算法**：通过航向角变化量识别左转行为
- **可调阈值**：支持自定义航向角变化阈值（默认30度）
- **轨迹质量过滤**：自动过滤掉过短或无效的轨迹数据
- **角度跨越处理**：智能处理-180°到180°的角度跨越问题

```python
def identify_left_turn_vehicles(self, heading_threshold=30):
    """识别左转车辆"""
    # 计算每个车辆的航向角变化
    # 应用左转判断逻辑
    # 过滤和筛选左转车辆
```

### 3. **样例车辆选择**
- **代表性选择**：从识别出的左转车辆中选择代表性样例
- **数量可控**：支持自定义样例数量（默认5个）
- **质量筛选**：基于轨迹长度、完整性等指标进行筛选
- **多样性保证**：确保选择的样例具有代表性和多样性

```python
def select_sample_vehicles(self, num_samples=5):
    """选择代表性的左转车辆样例"""
    # 基于轨迹质量排序
    # 选择最佳样例
    # 确保样例多样性
```

### 4. **特征提取与分析**

#### 运动特征
- **速度分析**：瞬时速度、平均速度、最大速度
- **加速度分析**：加速度变化、加速度分布
- **轨迹长度**：总行驶距离、轨迹复杂度

#### 几何特征
- **位置信息**：起始位置、结束位置坐标
- **航向角变化**：总航向角变化量、变化率
- **轨迹形状**：轨迹曲率、转弯半径

#### 时间特征
- **行驶时间**：总行驶时间、各阶段时间
- **帧数统计**：数据点数量、采样频率
- **时间序列分析**：速度-时间、位置-时间关系

```python
def extract_features(self, vehicle_data):
    """提取车辆特征"""
    # 计算运动特征
    # 提取几何特征
    # 分析时间特征
    # 返回特征字典
```

### 5. **可视化分析**

#### 轨迹可视化
- **2D轨迹图**：车辆行驶轨迹的平面可视化
- **多车辆对比**：同时显示多个车辆的轨迹
- **颜色编码**：不同车辆使用不同颜色区分
- **关键点标注**：标注起点、终点、转弯点等

#### 特征图表
- **速度时间序列**：速度随时间的变化曲线
- **加速度分析**：加速度的时间序列和分布
- **航向角变化**：航向角随时间的变化趋势
- **统计分布图**：各项特征的统计分布

#### 对比分析
- **多样例对比**：多个样例车辆的特征对比
- **统计图表**：左转车辆的整体统计分析
- **性能指标**：识别准确率、覆盖率等指标

```python
def visualize_trajectories(self, vehicle_ids):
    """可视化车辆轨迹"""
    # 创建多子图布局
    # 绘制轨迹曲线
    # 添加标注和图例
    # 保存图表文件
```

### 6. **报告生成**

#### 详细分析报告
- **文本报告**：包含所有分析结果的详细文本报告
- **特征数据表**：每个样例车辆的完整特征数据
- **统计摘要**：左转车辆的统计信息和分布
- **分析结论**：基于数据的分析结论和建议

#### 文件输出
- **CSV数据文件**：结构化的特征数据表
- **图表文件**：PNG格式的可视化图表
- **报告文档**：Markdown或文本格式的分析报告

```python
def generate_report(self):
    """生成分析报告"""
    # 创建详细报告
    # 保存特征数据
    # 输出可视化图表
    # 生成摘要统计
```

## 🔧 技术特点

### 智能算法
- **精确航向角计算**：使用 `np.arctan2(dy, dx)` 函数精确计算车辆行驶方向
- **角度标准化**：自动处理角度跨越问题，确保角度在-180°到180°范围内
- **数据平滑处理**：对轨迹数据进行平滑处理，减少GPS噪声影响
- **异常值检测**：自动识别和处理异常的轨迹数据点

### 数据兼容性
- **NGSIM格式支持**：完全兼容NGSIM数据格式和字段结构
- **列名自适应**：自动适配小写列名格式（vehicle_id, local_x, local_y等）
- **缺失值处理**：智能处理数据中的缺失值和异常值
- **多数据源支持**：可扩展支持其他交通数据格式

### 可视化效果
- **中文字体支持**：支持中文字体显示，适合中文环境
- **多图表布局**：使用matplotlib的subplot创建复合图表
- **颜色编码系统**：不同车辆使用不同颜色，便于区分
- **详细图例说明**：提供详细的图例和标注信息

### 性能优化
- **内存效率**：优化大数据集的内存使用
- **计算效率**：使用向量化操作提高计算速度
- **并行处理**：支持多车辆并行分析
- **缓存机制**：缓存中间计算结果，避免重复计算

## 📊 输出结果

### 1. 控制台输出示例
```
开始左转车辆数据筛选和轨迹分析...
正在加载数据: ../data/peachtree_filtered_data.csv
数据加载成功，共 873887 条记录
包含 15234 辆车辆
正在识别左转车辆...
识别出 1247 辆左转车辆
左转车辆占比: 8.19%
选择了 5 个代表性样例车辆进行详细分析
正在提取特征和生成可视化...
分析完成！结果已保存到文件。
```

### 2. 可视化图表
- **轨迹分析图**：显示选定车辆的完整行驶轨迹，包括起点、终点和转弯过程
- **特征时间序列**：速度、加速度、航向角随时间的变化曲线
- **特征对比图**：多个车辆的特征对比分析
- **统计分布图**：左转车辆的各项统计指标分布

### 3. 数据文件输出
- **left_turn_analysis_report.txt**：详细的文本分析报告
- **sample_vehicles_features.csv**：样例车辆的特征数据表
- **left_turn_trajectories.png**：轨迹可视化图表
- **feature_analysis.png**：特征分析图表

## 🎮 使用方式

### 1. 交互式运行
```bash
python src/左转数据分析脚本.py
```
程序会提示用户输入：
- 数据文件路径（默认：../data/peachtree_filtered_data.csv）
- 分析样例数量（默认：5）

### 2. 编程调用
```python
from 左转数据分析脚本 import LeftTurnAnalyzer

# 创建分析器
analyzer = LeftTurnAnalyzer('data/peachtree_filtered_data.csv')

# 执行完整分析流程
analyzer.load_data()
analyzer.identify_left_turn_vehicles(heading_threshold=30)
analyzer.select_sample_vehicles(num_samples=5)
analyzer.run_complete_analysis()
```

### 3. 自定义参数
```python
# 自定义航向角阈值
analyzer.identify_left_turn_vehicles(heading_threshold=25)

# 自定义样例数量
analyzer.select_sample_vehicles(num_samples=10)

# 自定义输出目录
analyzer.set_output_directory('results/')
```

## 🎯 应用场景

### 1. 交通工程研究
- **交叉路口设计**：分析左转行为模式，优化交叉路口设计
- **交通流分析**：研究左转车辆对整体交通流的影响
- **容量评估**：评估交叉路口的左转通行能力

### 2. 自动驾驶开发
- **行为建模**：为自动驾驶系统建立左转行为模型
- **路径规划**：优化自动驾驶车辆的左转路径规划
- **安全评估**：评估自动驾驶系统的左转安全性

### 3. 交通安全分析
- **事故预防**：识别左转过程中的潜在安全风险点
- **风险评估**：评估不同左转模式的安全风险
- **改进建议**：提出交通安全改进建议

### 4. 智能交通系统
- **信号优化**：为交通信号控制系统提供左转数据支持
- **实时监控**：实时监控和分析左转车辆行为
- **预测控制**：基于历史数据预测左转需求

### 5. 学术研究
- **交通流理论**：支持交通流理论的研究和验证
- **车辆行为研究**：深入研究车辆左转行为特征
- **模型验证**：为交通仿真模型提供验证数据

## 📈 技术优势

### 1. 准确性
- **高精度识别**：基于航向角变化的左转识别准确率高
- **多维特征**：综合考虑位置、速度、时间等多维特征
- **异常处理**：有效处理数据异常和边界情况

### 2. 可扩展性
- **模块化设计**：各功能模块独立，便于扩展和维护
- **参数可调**：关键参数可调节，适应不同场景需求
- **接口友好**：提供清晰的编程接口，便于集成

### 3. 实用性
- **即用性强**：开箱即用，无需复杂配置
- **结果直观**：提供丰富的可视化结果
- **报告详细**：生成详细的分析报告和数据文件

### 4. 性能
- **处理能力强**：能够处理大规模交通数据
- **计算效率高**：优化的算法确保快速处理
- **内存友好**：合理的内存使用策略

## 🔄 与项目其他组件的关系

### 1. 数据预处理
- 为主要的轨迹预测模型提供预处理后的左转车辆数据
- 生成的特征数据可直接用于模型训练

### 2. 模型训练
- 识别出的左转车辆数据作为训练样本
- 提取的特征可作为模型的输入特征

### 3. 评估验证
- 分析结果可用于验证轨迹预测模型的性能
- 提供基准数据用于模型对比

### 4. 可视化展示
- 生成的图表可用于项目展示和报告
- 分析结果支持项目的技术说明

## 📝 注意事项

### 1. 数据要求
- 需要包含vehicle_id, frame_id, local_x, local_y等关键字段
- 数据应按时间顺序排列
- 建议数据采样频率不低于10Hz

### 2. 参数调节
- 航向角阈值需要根据具体路口特征调节
- 样例数量应根据分析需求确定
- 可视化参数可根据显示需求调整

### 3. 性能考虑
- 大数据集处理时注意内存使用
- 可视化图表数量过多时可能影响性能
- 建议分批处理超大规模数据

---

**总结**：左转数据分析脚本是车辆左转轨迹预测系统的核心分析工具，通过智能的左转识别算法、全面的特征提取和丰富的可视化功能，为交通工程研究、自动驾驶开发和智能交通系统提供了强有力的数据分析支持。该脚本不仅具有很强的实用性和准确性，还具备良好的可扩展性和易用性，是进行车辆行为分析的重要工具。