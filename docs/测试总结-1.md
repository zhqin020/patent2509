基于提供的训练和评估结果，我将对车辆左转轨迹预测系统的性能进行详细分析，解释测试结果，评估模型是否有效，并总结其优劣势和改进建议。

## 测试输出：

🚀 车辆左转轨迹预测系统
基于历史轨迹的真正左转意图预测
============================================================
💻 使用设备: cpu
🎯 选择预测模式:
1. 真正的预测模式 (推荐) - 基于历史轨迹预测未来左转意图
2. 传统模式 - 多模态特征融合
请选择模式 (1/2, 默认: 1):
请输入要处理的最大样本数 (默认: 全部，输入正整数可缩减调试时间): 20000
✅ 使用真正的预测模式
   - 历史长度: 30帧 (3秒)
   - 预测范围: 50帧 (5秒)
   - 利用NGSIM movement标签进行真正的预测
   - 限制最大样本数: 20000
🔄 创建数据集...
请输入NGSIM数据路径 (默认: E:\Work\zq\202509\patent2509\src\../data/peachtree_filtered_data.csv):
是否按路口和方向筛选数据？(y/n, 默认: y): n
请输入训练轮数 epochs (默认: epochs=50): 10
✅ 用户选择不按路口和方向筛选数据，使用全部数据
🔄 开始构建数据集...
正在加载数据: E:\Work\zq\202509\patent2509\src\../data/peachtree_filtered_data.csv
✅ 已加载完整数据: 873887 条记录
✅ 已加载并过滤数据: 873887/873887 条记录
包含 1545 辆车辆
✅ 使用全部数据，不进行路口和方向筛选
✅ 数据准备完成: 873887 条记录, 1545 辆车
   左转车辆数: 605 (39.2%)
🚀 初始化数据集 (预测模式: 开启)
   历史长度: 30帧 (3.0秒)
   预测范围: 12帧 (1.2秒)
✅ 直接加载DataFrame数据: 873887 条记录, 1545 辆车
🔄 构建预测样本...
处理车辆数据:   3%| | 39/1545 [00:23<13:01,  1.93辆/s, 有效车辆=24, 样本数 🔄 已达到最大样本数限制 (20000个样本)
处理车辆数据: 100%|█| 1545/1545 [00:23<00:00, 65.86辆/s, 有效车辆=24, 样本 
✅ 构建预测样本: 20000 个
📊 预测数据集分析:
   总样本数: 20,000
分析进度:   0%|                                     | 0/5 [00:00<?, ?项/s]   左转样本: 642 (3.2%)
   非左转样本: 19,358 (96.8%)
   涉及车辆数: 25
   平均每车样本数: 800.0
   样本时间跨度: 22帧 (2.2秒)
   轨迹空间范围: x[-33.1, 53.1], y[218.9, 2038.3]
   关键运动特征统计分析:
     速度统计: 均值=11.04 m/s, 标准差=14.71 m/s, 
              最小值=0.00 m/s, 最大值=47.04 m/s
     加速度统计: 均值=0.11 m/s², 标准差=4.89 m/s²,
                最小值=-12.27 m/s², 最大值=12.27 m/s²
     航向角统计: 均值=51.31°, 标准差=43.03°,
                最小值=-176.81°, 最大值=171.71°
分析进度: 100%|█████████████████████████████| 5/5 [00:00<00:00,  9.27项/s] 
📊 数据集划分: 训练=14000, 验证=3000, 测试=3000

📊 各数据集左转车辆分布统计 (按movement):
   训练集:
      总车辆数: 14,000
      左转车辆数: 132 (0.9%)
   验证集:
      总车辆数: 3,000
      左转车辆数: 355 (11.8%)
   测试集:
      总车辆数: 3,000
      左转车辆数: 155 (5.2%)
创建模型...
开始训练...
🚀 开始训练...
📊 训练集大小: 14,000
📊 验证集大小: 3,000
🎯 目标轮数: 10
⏰ 早停耐心: 15
💻 设备: cpu
================================================================================
Overall Progress:   0%| | 0/10 [02:57<?, ?it/s, Train_Loss=315438.9522, Va 📈 Epoch   1/10 | ⏱️ 176.3s | 🔄 Train: 315438.9522 | ✅ Valid: 338579.63633 | 🎯 Acc: 0.882 | 📏 TrajErr: 686.948
    📉 LR: 1.00e-03 | ⏳ ETA: 26.4min | 🕐 Total: 2.9min | 💾 [BEST]       
Overall Progress:  10%| | 1/10 [06:07<26:37, 177.48s/it, Train_Loss=290562 📈 Epoch   2/10 | ⏱️ 190.1s | 🔄 Train: 290562.8840 | ✅ Valid: 311930.29488 | 🎯 Acc: 0.882 | 📏 TrajErr: 648.217
    📉 LR: 1.00e-03 | ⏳ ETA: 24.5min | 🕐 Total: 6.1min | 💾 [BEST]       
Overall Progress:  20%|▏| 2/10 [09:29<24:39, 184.89s/it, Train_Loss=266862 📈 Epoch   3/10 | ⏱️ 201.6s | 🔄 Train: 266862.9365 | ✅ Valid: 287011.86344 | 🎯 Acc: 0.882 | 📏 TrajErr: 611.356
    📉 LR: 1.00e-03 | ⏳ ETA: 22.1min | 🕐 Total: 9.5min | 💾 [BEST]       
Overall Progress:  30%|▎| 3/10 [12:47<22:28, 192.61s/it, Train_Loss=244949 📈 Epoch   4/10 | ⏱️ 198.5s | 🔄 Train: 244949.0477 | ✅ Valid: 263732.62288 | 🎯 Acc: 0.882 | 📏 TrajErr: 576.493
    📉 LR: 1.00e-03 | ⏳ ETA: 19.2min | 🕐 Total: 12.8min | 💾 [BEST]      
Overall Progress:  40%|▍| 4/10 [16:10<19:29, 194.93s/it, Train_Loss=224561 📈 Epoch   5/10 | ⏱️ 202.8s | 🔄 Train: 224561.5129 | ✅ Valid: 242071.02977 | 🎯 Acc: 0.882 | 📏 TrajErr: 547.490
    📉 LR: 1.00e-03 | ⏳ ETA: 16.2min | 🕐 Total: 16.2min | 💾 [BEST]      
Overall Progress:  50%|▌| 5/10 [19:23<16:28, 197.77s/it, Train_Loss=206128 📈 Epoch   6/10 | ⏱️ 192.9s | 🔄 Train: 206128.4702 | ✅ Valid: 221996.77611 | 🎯 Acc: 0.882 | 📏 TrajErr: 528.102
    📉 LR: 1.00e-03 | ⏳ ETA: 12.9min | 🕐 Total: 19.4min | 💾 [BEST]      
Overall Progress:  60%|▌| 6/10 [22:36<13:04, 196.11s/it, Train_Loss=188919 📈 Epoch   7/10 | ⏱️ 192.9s | 🔄 Train: 188919.2322 | ✅ Valid: 203531.41700 | 🎯 Acc: 0.882 | 📏 TrajErr: 510.872
    📉 LR: 1.00e-03 | ⏳ ETA: 9.7min | 🕐 Total: 22.6min | 💾 [BEST]       
Overall Progress:  70%|▋| 7/10 [25:50<09:45, 195.08s/it, Train_Loss=173612 📈 Epoch   8/10 | ⏱️ 193.5s | 🔄 Train: 173612.6897 | ✅ Valid: 186668.41911 | 🎯 Acc: 0.882 | 📏 TrajErr: 495.024
    📉 LR: 1.00e-03 | ⏳ ETA: 6.5min | 🕐 Total: 25.8min | 💾 [BEST]       
Overall Progress:  80%|▊| 8/10 [28:59<06:29, 194.59s/it, Train_Loss=159578 📈 Epoch   9/10 | ⏱️ 189.8s | 🔄 Train: 159578.8604 | ✅ Valid: 171394.98866 | 🎯 Acc: 0.882 | 📏 TrajErr: 480.013
    📉 LR: 1.00e-03 | ⏳ ETA: 3.2min | 🕐 Total: 29.0min | 💾 [BEST]       
Overall Progress:  90%|▉| 9/10 [32:22<03:13, 193.09s/it, Train_Loss=147369 📈 Epoch  10/10 | ⏱️ 203.1s | 🔄 Train: 147369.3729 | ✅ Valid: 157718.61433 | 🎯 Acc: 0.882 | 📏 TrajErr: 466.023
    📉 LR: 1.00e-03 | ⏳ ETA: 0.0min | 🕐 Total: 32.4min | 💾 [BEST]       
Overall Progress: 100%|█| 10/10 [32:22<00:00, 194.30s/it, Train_Loss=14736 
================================================================================
🎉 训练完成！
⏱️ 总训练时间: 32.4 分钟
🏆 最佳验证损失: 157718.6143
💾 最佳模型已保存为: best_model.pth
================================================================================
评估模型...
📈 开始评估模型性能...
评估进度: 100%|██████████| 94/94 [00:32<00:00,  2.93批/s, 已处理样本=2256] 
✅ 模型评估完成，开始计算性能指标...
============================================================
                        模型评估结果
============================================================
意图识别准确率: 0.9483
意图识别精确率: 0.0000
意图识别召回率: 0.0000
意图识别F1分数: 0.0000
----------------------------------------
轨迹预测ADE: 635.5621 m
轨迹预测FDE: 637.7852 m
============================================================
📊 基于真实左转数据的验证结果 (与左转数据分析脚本对比):
   - 真正左转车辆数: 0/3000
   - 预测准确率: 1.0000
   - 精确率: 0.0000
   - 召回率: 0.0000
   - F1分数: 0.0000
============================================================
训练和评估完成！
---

### 1. **测试结果解读**
测试结果包含两部分：**整体模型性能**（意图识别和轨迹预测）和**基于真实左转数据的验证**。以下逐一分析：

#### 1.1 **整体模型性能**
- **意图识别（左转预测）**：
  - 准确率（Accuracy）：0.9483
  - 精确率（Precision）：0.0000
  - 召回率（Recall）：0.0000
  - F1分数：0.0000
- **轨迹预测**：
  - ADE（平均位移误差）：635.5621米
  - FDE（最终位移误差）：637.7852米

**解读**：
- **意图识别**：
  - **准确率（0.9483）**：模型在测试集上预测正确（左转或非左转）的比例为94.83%。看似较高，但需结合其他指标分析。
  - **精确率、召回率、F1分数均为0**：这表明模型完全未能正确预测任何左转样本（`movement=2`）。高准确率可能是因为测试集中左转样本极少（5.2%，即155/3000），模型倾向于预测非左转，导致对非左转样本预测准确，但对左转样本完全失效。
- **轨迹预测**：
  - **ADE（635.56米）和FDE（637.79米）**：误差极高，远超车辆轨迹预测的合理范围（通常期望<2米，参考NGSIM相关研究）。这表明模型在预测车辆未来位置时几乎完全失败，无法生成有意义的轨迹。

#### 1.2 **基于真实左转数据的验证**
- **真正左转车辆数**：0/3000
- **预测准确率**：1.0000
- **精确率**：0.0000
- **召回率**：0.0000
- **F1分数**：0.0000

**解读**：
- **真正左转车辆数为0**：测试集中标注为`movement=2`的左转样本数量为0，与数据集划分统计（测试集左转样本155，占比5.2%）矛盾。这可能是评估脚本错误或测试集子集选择问题，导致评估时未包含任何左转样本。
- **预测准确率（1.0000）**：由于没有左转样本，模型预测所有样本为非左转，正确率看似为100%，但这没有意义，因为未测试模型对左转的预测能力。
- **精确率、召回率、F1为0**：进一步确认模型未预测任何左转样本，验证结果无效。

#### 1.3 **训练过程**
- **训练时间**：32.4分钟，10轮（epochs），最佳验证损失157718.6143。
- **训练集损失**：147369.3729（第10轮）。
- **验证集准确率**：0.882（第10轮），轨迹误差466.023米。
- **数据集划分**：
  - 训练集：14000样本，左转占比0.9%（132样本）。
  - 验证集：3000样本，左转占比11.8%（355样本）。
  - 测试集：3000样本，左转占比5.2%（155样本）。
- **样本限制**：最大20000样本，涉及25辆车，左转样本642（3.2%）。

**解读**：
- **损失值极高**：验证损失（157718.6143）和训练损失（147369.3729）异常高，可能由于损失函数设计不当（例如，未归一化轨迹坐标，或轨迹预测的L2损失权重过大）。
- **左转样本稀疏**：训练集中左转样本仅0.9%，可能导致模型难以学习左转特征。
- **轨迹误差**：验证集轨迹误差466米，测试集635米，均远超可接受范围，表明轨迹预测模型失效。

---

### 2. **模型是否有效**
综合评估，**模型在当前测试中无效**，原因如下：
- **意图识别失败**：
  - 尽管整体准确率0.9483，但精确率、召回率和F1分数为0，表明模型完全未能预测左转行为。
  - 测试集中标注的左转样本为0（与5.2%矛盾），说明评估过程有误，未真正验证模型对左转的预测能力。
- **轨迹预测失败**：
  - ADE（635.56米）和FDE（637.79米）远超合理范围（<2米），表明轨迹预测毫无实用价值。
- **测试集问题**：
  - 测试集标注的“真正左转车辆数: 0/3000”与数据集划分统计（155左转样本）不符，表明评估脚本或测试子集选择存在错误，导致结果不可靠。
- **训练问题**：
  - 训练集左转样本占比低（0.9%），可能导致模型偏向非左转预测。
  - 损失值过高，轨迹误差过大，暗示模型架构、特征选择或损失函数不适合任务。

**结论**：模型在意图识别和轨迹预测上均未达到预期效果，测试结果因数据问题而不可靠。模型未能有效预测左转行为，轨迹预测误差过高，无法用于实际应用（如ADAS或自动驾驶）。

---

### 3. **模型优劣势分析**
#### 优势
1. **数据准备充分**：
   - 使用NGSIM Peachtree Street数据集（873887条记录，1545辆车），数据量充足。
   - 成功提取20000个样本，历史长度30帧（3秒），预测范围12帧（1.2秒），符合实时预测需求。
   - 特征统计（速度、加速度、航向角）分析详细，为特征选择提供了基础。
2. **训练流程稳定**：
   - 训练完成10轮，耗时32.4分钟，保存了最佳模型（best_model.pth）。
   - 验证集准确率0.882，表明模型在部分数据上有一定学习能力。
3. **灵活的预测模式**：
   - 提供“真正预测模式”（基于历史轨迹预测未来左转），设计合理，适合意图预测任务。

#### 劣势
1. **左转预测失效**：
   - 模型未能预测任何左转样本（精确率、召回率、F1为0），可能是由于训练集左转样本过少（0.9%）或类别不平衡未处理。
2. **轨迹预测误差极高**：
   - ADE/FDE（635-637米）远超可接受范围，可能由于模型架构不适合轨迹预测，或输入特征不足（如未充分利用`space_headway`, `preceding`等交互特征）。
3. **测试集问题**：
   - 测试集标注0左转样本，与数据集划分（5.2%左转）矛盾，表明评估过程有误，未能验证模型对左转的泛化能力。
4. **损失值异常**：
   - 验证损失157718.6143和训练损失147369.3729极高，可能由于轨迹坐标未归一化，或损失函数设计不当（如轨迹和意图预测的权重失衡）。
5. **训练轮数不足**：
   - 仅10轮训练，且无明显收敛迹象（损失仍高），可能未充分优化模型。

---

### 4. **可能的问题原因**
1. **测试集标注错误**：
   - 评估结果显示“真正左转车辆数: 0/3000”，但数据集划分表明测试集有155个左转样本（5.2%）。这可能是评估脚本错误，或测试时使用了错误子集。
2. **类别不平衡**：
   - 训练集左转样本仅0.9%（132/14000），可能导致模型过拟合非左转样本，忽略左转特征。
3. **轨迹预测模型不足**：
   - ADE/FDE过高，可能由于：
     - 模型架构（如LSTM）未捕捉复杂时空关系。
     - 特征选择不足，未加入交互特征（如`space_headway`, `preceding`车辆位置）。
     - 数据未归一化，导致轨迹预测损失过大。
4. **损失函数设计问题**：
   - 验证损失和训练损失极高，可能由于轨迹预测的L2损失主导总损失，未平衡意图识别的交叉熵损失。
5. **训练不足**：
   - 10轮训练可能不足以让模型收敛，尤其对于稀疏的左转样本。

---

### 5. **改进建议**
为提升模型有效性，建议以下改进：

#### 5.1 **修复测试集问题**
- **检查测试集标注**：
  - 验证测试集中是否包含左转样本（`movement=2`）：
    ```python
    print(test_data['movement'].value_counts())
    ```
  - 若测试集确实包含155个左转样本，检查评估脚本是否错误过滤了数据（如仅评估了`int_id=0`的子集）。
- **重新划分数据集**：
  - 使用分层采样确保训练/验证/测试集的左转比例一致：
    ```python
    from sklearn.model_selection import train_test_split
    left_turn_data = traj_data[traj_data['movement'] == 2]
    non_left_turn_data = traj_data[traj_data['movement'] != 2]
    train_left, test_left = train_test_split(left_turn_data, test_size=0.15, random_state=42)
    train_non_left, test_non_left = train_test_split(non_left_turn_data, test_size=0.15, random_state=42)
    train_data = pd.concat([train_left, train_non_left])
    test_data = pd.concat([test_left, test_non_left])
    print(test_data['movement'].value_counts())
    ```

#### 5.2 **处理类别不平衡**
- **过采样左转样本**：
  - 使用SMOTE增加训练集中的左转样本：
    ```python
    from imblearn.over_sampling import SMOTE
    X, y = create_sequences(traj_data)  # 参考之前序列创建代码
    smote = SMOTE(random_state=42)
    X_resampled, y_resampled = smote.fit_resample(X.reshape(X.shape[0], -1), y)
    X_resampled = X_resampled.reshape(-1, seq_length, len(features))
    ```
- **加权损失函数**：
  - 为左转样本分配更高权重：
    ```python
    from tensorflow.keras.losses import BinaryCrossentropy
    class_weights = {0: 1.0, 1: 10.0}  # 左转权重更高
    model.compile(loss=BinaryCrossentropy(), optimizer='adam', metrics=['accuracy'])
    ```

#### 5.3 **优化轨迹预测**
- **改进模型架构**：
  - 尝试Graph Neural Networks（GNN）或Transformer（如Temporal Fusion Transformer），捕捉车辆交互和长期依赖。
  - 示例Transformer模型：
    ```python
    from tensorflow.keras.layers import MultiHeadAttention, Dense
    model = Sequential([
        MultiHeadAttention(num_heads=4, key_dim=64, input_shape=(seq_length, len(features))),
        Dense(32, activation='relu'),
        Dense(1, activation='sigmoid')  # 意图预测
        # 添加轨迹预测头：Dense(seq_length * 2) for (x, y) coordinates
    ])
    ```
- **特征工程**：
  - 加入交互特征（`space_headway`, `time_headway`, `preceding`车辆的速度/位置）。
  - 归一化轨迹数据：
    ```python
    from sklearn.preprocessing import StandardScaler
    scaler = StandardScaler()
    traj_data[['local_x', 'local_y', 'v_vel']] = scaler.fit_transform(traj_data[['local_x', 'local_y', 'v_vel']])
    ```
- **优化损失函数**：
  - 分离意图识别和轨迹预测的损失，设置适当权重：
    ```python
    def combined_loss(y_true, y_pred, intent_weight=1.0, traj_weight=0.1):
        intent_loss = BinaryCrossentropy()(y_true[:, 0], y_pred[:, 0])
        traj_loss = tf.reduce_mean(tf.square(y_true[:, 1:] - y_pred[:, 1:]))
        return intent_weight * intent_loss + traj_weight * traj_loss
    ```

#### 5.4 **增加训练轮数**
- 增加epochs（如50轮），并监控损失收敛：
  ```python
  from tensorflow.keras.callbacks import EarlyStopping
  early_stopping = EarlyStopping(monitor='val_loss', patience=15, restore_best_weights=True)
  model.fit(X_train, y_train, epochs=50, validation_data=(X_val, y_val), callbacks=[early_stopping])
  ```

#### 5.5 **验证和可视化**
- **可视化预测**：
  - 绘制预测轨迹与真实轨迹对比：
    ```python
    import matplotlib.pyplot as plt
    predicted_traj = model.predict(X_test[:1])
    plt.plot(X_test[0, :, 0], X_test[0, :, 1], label='Input Trajectory')
    plt.plot(predicted_traj[0, :, 0], predicted_traj[0, :, 1], label='Predicted Trajectory')
    plt.legend()
    plt.show()
    ```
- **分析左转样本**：
  - 检查左转样本的预测结果，确认模型是否捕捉到左转特征。

#### 5.6 **按交叉口筛选**：
- 尽管用户选择不按`int_id`筛选，建议尝试筛选`int_id ≠ 0`的数据，聚焦交叉口行为：
  ```python
  intersection_data = traj_data[traj_data['int_id'] != 0]
  intersection_vehicles = intersection_data['vehicle_id'].unique()
  traj_data = traj_data[traj_data['vehicle_id'].isin(intersection_vehicles)]
  ```

---

### 6. **结论**
- **模型有效性**：当前模型无效。意图识别未能预测任何左转样本（精确率、召回率、F1为0），轨迹预测误差极高（ADE/FDE > 635米）。测试集标注问题（0左转样本）使评估结果不可靠。
- **优势**：数据准备充分，训练流程稳定，支持提前预测（1.2秒）。
- **劣势**：左转预测失效、轨迹误差过高、测试集标注错误、训练集左转样本不足、损失值异常。
- **改进方向**：修复测试集标注，处理类别不平衡，优化轨迹预测模型，增加交互特征，延长训练轮数，重新评估。

通过上述改进，模型有望在左转意图识别和轨迹预测上取得更好效果。建议优先检查测试集问题，并使用SMOTE和加权损失函数增强左转预测能力。